# .github/workflows/automerge-dependabot.yml
name: ğŸ¤– Auto-merge

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
    paths-ignore:
      - '**.md'
      - '.gitignore'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  statuses: write
  id-token: write

env:
  AWS_REGION: ap-southeast-2

jobs:
  detect_changes:
    name: ğŸ•µï¸ Detect PR type
    if: |
      (
        github.event.pull_request.user.login == 'dependabot[bot]' ||
        contains(github.event.pull_request.labels.*.name, 'automerge')
      ) &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-24.04-arm
    outputs:
      is_python: ${{ steps.detect_pr_type.outputs.IS_PYTHON_PR }}
      is_terraform: ${{ steps.detect_pr_type.outputs.IS_TERRAFORM_PR }}
    steps:
      - name: ğŸ“¦ Checkout PR code
        uses: actions/checkout@v5
        with:
          fetch-depth: 2 # Required to diff HEAD^

      - name: ğŸ•µï¸ Detect PR type
        id: detect_pr_type
        run: |
          # Determine if this is a Terraform PR based on changed files
          if git diff --name-only HEAD^ HEAD | grep -q "iac/.*\.tf"; then
            echo "IS_TERRAFORM_PR=true" >> $GITHUB_OUTPUT
          else
            echo "IS_TERRAFORM_PR=false" >> $GITHUB_OUTPUT
          fi
          
          # Determine if this is a Python PR
          if git diff --name-only HEAD^ HEAD | grep -q "pyproject.toml\|uv.lock"; then
            echo "IS_PYTHON_PR=true" >> $GITHUB_OUTPUT
          else
            echo "IS_PYTHON_PR=false" >> $GITHUB_OUTPUT
          fi

  terraform_validate:
    name: âœ… Terraform Validate
    needs: [detect_changes]
    if: needs.detect_changes.outputs.is_terraform == 'true'
    runs-on: ubuntu-24.04-arm
    steps:

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: ğŸ’¾ Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: iac/.terraform
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/iac/.terraform.lock.hcl') }}

      - name: âš™ï¸ Terraform Init
        run: cd iac && terraform init

      - name: âœ… Terraform Validate
        run: cd iac && terraform validate

  run_python_tests:
    name: ğŸ§ª Run Python Tests
    needs: [detect_changes]
    if: needs.detect_changes.outputs.is_python == 'true'
    runs-on: ubuntu-24.04-arm
    steps:
      - name: ğŸ“¦ Checkout PR code
        uses: actions/checkout@v5

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install uv
        run: pip install uv

      - name: ğŸ“¥ Install Python dependencies
        run: uv sync

      - name: ğŸ§ª Run Tests
        run: make test

  approve_and_merge:
    name: âœ… Approve and Merge
    needs: [detect_changes, terraform_validate, run_python_tests]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-24.04-arm
    steps:
      - name: âœ… Approve and Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"

  handle_failure:
    name: ğŸš¨ Handle Failure
    needs: [approve_and_merge]
    if: failure()
    runs-on: ubuntu-24.04-arm
    steps:
      - name: ğŸš¨ Handle Failure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr edit "$PR_URL" --add-label "breaking-change-detected"
          gh pr comment "$PR_URL" --body "## ğŸš¨ Auto-Merge Failed - Checks Failed

          Tests failed for this PR.
          
          If this is a Dependabot PR, an AI agent may be dispatched to attempt a fix.
          
          Next steps:
          1. Review the workflow logs to identify the specific failure.
          2. If this is a dependency update, check for breaking changes.
          3. Run tests locally (\`make test\`) to reproduce the issue."
          
          if [ "${{ needs.detect_changes.outputs.is_python }}" = "true" ]; then
            gh pr comment "$PR_URL" --body "For Python updates:
            - Check release notes for breaking changes
            - Run \`uv sync\` locally
            - Update code as needed
            - Run \`make test\` to ensure all tests pass"
          elif [ "${{ needs.detect_changes.outputs.is_terraform }}" = "true" ]; then
            gh pr comment "$PR_URL" --body "For Terraform updates:
            - Check provider changelog
            - Run \`cd iac && terraform init\` and \`terraform validate\` locally"
          fi
