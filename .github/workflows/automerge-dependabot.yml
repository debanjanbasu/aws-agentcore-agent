# .github/workflows/automerge-dependabot.yml
name: Dependabot Auto-merge

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    paths-ignore:
      - '**.md'
      - '.gitignore'

permissions:
  contents: write
  pull-requests: write
  statuses: write

env:
  AWS_REGION: ap-southeast-2 # Default AWS region

jobs:
  automerge:
    # Only run on PRs from dependabot that are not in draft
    if: github.event.pull_request.user.login == 'dependabot[bot]' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v5

      - name: Detect PR type
        run: |
          # Determine if this is a Terraform PR based on changed files
          if git diff --name-only HEAD^ HEAD | grep -q "iac/.*\.tf"; then
            echo "IS_TERRAFORM_PR=true" >> $GITHUB_ENV
          else
            echo "IS_TERRAFORM_PR=false" >> $GITHUB_ENV
          fi
          
          # Determine if this is a Python PR
          if git diff --name-only HEAD^ HEAD | grep -q "pyproject.toml\|uv.lock"; then
            echo "IS_PYTHON_PR=true" >> $GITHUB_ENV
          else
            echo "IS_PYTHON_PR=false" >> $GITHUB_ENV
          fi

      # Python Dependency Updates
      - name: Set up Python
        if: env.IS_PYTHON_PR == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Use a compatible Python version

      - name: Install uv
        if: env.IS_PYTHON_PR == 'true'
        run: pip install uv

      - name: Install Python dependencies
        if: env.IS_PYTHON_PR == 'true'
        run: uv sync

      # Terraform Dependency Updates
      - name: Setup Terraform
        if: env.IS_TERRAFORM_PR == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Cache Terraform plugins
        if: env.IS_TERRAFORM_PR == 'true'
        uses: actions/cache@v4
        with:
          path: iac/.terraform
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/iac/.terraform.lock.hcl') }}

      - name: Terraform Init
        if: env.IS_TERRAFORM_PR == 'true'
        run: |
          cd iac && terraform init

      - name: Terraform Validate
        if: env.IS_TERRAFORM_PR == 'true'
        run: |
          cd iac && terraform validate

      # Run appropriate tests based on PR type
      - name: Run Tests
        # For Dependabot PRs, we only run tests to verify compatibility
        run: |
          if [ "${{ env.IS_PYTHON_PR }}" = "true" ]; then
            make python-test
          elif [ "${{ env.IS_TERRAFORM_PR }}" = "true" ]; then
            echo "Terraform provider updates validated with terraform validate"
            # For Terraform updates, we rely on terraform validate
            # In the future, we could add more specific Terraform tests here
          else
            # Fallback to running all tests
            make test
          fi

      - name: Approve and Merge
        if: success() # Only run if tests pass
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"

      - name: Handle Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr edit "$PR_URL" --add-label "tests-failed"
          gh pr comment "$PR_URL" --body "## ðŸš¨ Auto-Merge Failed

          Tests failed for this Dependabot PR. Please review the workflow logs for details."
